# session-name for assumed role

**mbolek** commented *Jan 30, 2020*

Hi, I'm trying use terragrunt and atlantis with some mixed up results - problem being the session name for assume-role. Currently it seems to be generated automatically:
`assumed-role/atlantis-test/a839d6a9-atlantis-test is not authorized to perform: sts:AssumeRole`
I've tried using `AWS_SESSION_TOKEN` and `AWS_ROLE_SESSION_NAME` but to no effect. Is it possible to somehow enforce setting of the session_name during assume_role to a specific string? I need this for principal in an IAM role to be assumed. The general idea works, if I use the above generated session name (`a839d6a9-atlantis-test`) as the principal but it would be changed with atlantis container restart. Any ideas would be more than welcome :)
<br />
***


**mbolek** commented *Jan 30, 2020*

Also... If I may try to squeeze in another question -> I've messed up a bit and currently have a single tfstate file (per environment) with all the modules inside and would like to modernize it into a typical tfstate per module. Is there a better/other idea than doing `state mv` to separate files manually and adding `terragrunt.hcl` with module's configuration ?
***

**yorinasub17** commented *Jan 31, 2020*

We actually don't use atlantis at Gruntwork so will need a bit more info here. Specifically, how are you assuming the initial role `atlantis-test`? Is that done:

- In atlantis? If so, can you point us to the documentation for how you are assuming the role?
- In terragrunt? If so, which mechanism?
- Outside both? If so, what command/mechanism?

---

For the second question, unfortunately there aren't any good refactoring tools available in either terraform or terragrunt. Your options are:

- Recreate the stack. This is typically preferred given the amount of resources you would have to touch. This is usually doable without downtime for applications and servers, but not for databases.
- Using a combination of `import` and `state rm`. The advantage of this approach is that if the `import` fails, you can "roll back" or start over by deleting the new state, since you don't remove from the old state until you explicitly call `state rm`.
- Using `state mv`.
***

**mbolek** commented *Jan 31, 2020*

hey Yoriyasu, thanks for the state suggestions, I'm sort of used to `state mv` with refactoring already to will probably try with that one.

---

As for atlantis  - it's running as a container inside kubernetes and gets its role with kube2iam and then I was hoping it could do another 'assume-role' for the correct credentials in VPC B. I am passing `iam_role = "arn:aws:iam:0123456789012:role/atlantis-testing` inside `terragrunt.hcl`. This role is created in VPC B but I would like to make it 'securer' by specifying only single principal that is able to assume it. AWS docs state it should look like this `"Principal": { "AWS": "arn:aws:sts::AWS-account-ID:assumed-role/role-name/role-session-name" }`. The last part seems to be generated somewhere. I have tried configuring provider in module's `main.tf`:
```
provider "aws" {                                                                                                        
  region  = var.aws_region                                                                                              
  version = "~> 2.0"                                                                                                    
  assume_role = {                                                                                                       
    session_name = "DEV_test_atlantis"                                                                                  
  }                                                                                                                     
}    
```
but it doesn't seem to be taken into account. I have also tried with env variable `AWS_ROLE_SESSION_NAME` which should work for aws-cli (https://docs.amazonaws.cn/en_us/cli/latest/userguide/cli-configure-role.html) but this one also doesn't change the session name I see in error message.
Additionally, from what I was told by atlantis team, atlantis is generally a wrapper so it should honor any setup (https://www.runatlantis.io/docs/provider-credentials.html). I've just thought of trying to create a `~/.aws/config` with `role_session_name` set, but it doesn't seem to affect anything.
Generally I think it is possible to achieve this double assume-role since if I add the autogenerated ID as a principal it works. The part that eludes me is the ID. Since terragrunt is the one that invokes the role assumption, is it maybe possible to set session_name directly?
Also, if I get into the container and exec terragrunt manually I get the same error with the same ID
***

**heitorlessa** commented *Jul 28, 2021*

Came here wondering if you found a solution @mbolek to this? 

I thought Terragrunt also supported AWS_ROLE_SESSION_NAME which makes it easier for auditing access later.
***

**mbolek** commented *Jul 30, 2021*

@heitorlessa sadly I did not. Tried for some time and postponed the idea for 'the near future' which unfortunately hasn't come yet :(
I guess you're also facing it today ? So either the tools haven't changed/caught up or it's not the correct way to do it
***

**yorinasub17** commented *Sep 27, 2021*

Sorry for the delay in responding here. Since this is using `iam_role` to assume the role, this is an issue in how terragrunt is assuming the role. I think we can solve this by specifying a new parameter `iam_role_session_name` and `--terragrunt-iam-role-session-name` to specify the session name when terragrunt assumes the role.

A PR to add this feature would be most appreciated! As far as pointers for implementation goes, the idea would be to expose those settings and plumb them through to https://github.com/gruntwork-io/terragrunt/blob/master/aws_helper/config.go#L142-L146
***

