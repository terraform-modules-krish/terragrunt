# Build issue v0.19.16

**forficate** commented *Aug 8, 2019*

Hi, I am trying to build terragrunt from source but get the below error message:
```
github.com/gruntwork-io/terragrunt/config
# github.com/gruntwork-io/terragrunt/config
go/src/github.com/gruntwork-io/terragrunt/config/config_helpers.go:95:16: cannot use v (type "github.com/hashicorp/terraform/vendor/github.com/zclconf/go-cty/cty/function".Function) as type "github.com/zclconf/go-cty/cty/function".Function in assignment
```

Tracking this down the break in compilation seems to happen between `v0.19.3` and `v0.19.4`.

Doing a diff on the two tags I can't see anything in `config_helpers` that has changed to cause that error. I do see `go-cty-yaml` is added and not sure if that would cause the issue:

```
+[[projects]]
+  digest = "1:7922171eda409496bd43979d690c2ba5d58912d9bc5cafdc0509e7cd5a6f8314"
+  name = "github.com/zclconf/go-cty-yaml"
+  packages = ["."]
+  pruneopts = "UT"
+  revision = "fbabe99bb1c897a56ed70103a40aa94fc50a7104"
+  version = "v0.1.0"
+```
<br />
***


**u-quark** commented *Aug 12, 2019*

@forficate Did you find a solution for this?
***

**forficate** commented *Aug 13, 2019*

No I didn't for v0.19.16.

However after creating this issue v0.19.19 was released and that builds ok.

Note I'm using [nix](https://nixos.org/nix/) to build with `go2nix` and `dep2nix`.

For reference the `terragrunt` derivation:
```
# This file was generated by https://github.com/kamilchm/go2nix v1.3.0
{ stdenv, buildGoPackage, fetchFromGitHub, fetchhg, fetchbzr, fetchsvn, makeWrapper, terraform }:

buildGoPackage rec {
  name = "terragrunt-${version}";
  version = "0.19.19";

  goPackagePath = "github.com/gruntwork-io/terragrunt";

  src = fetchFromGitHub {
    owner = "gruntwork-io";
    repo  = "terragrunt";
    rev   = "v${version}";
    sha256 = "0j7287g9lw06xvbxv9xi0g8zib0fbkihy67g7n1yygh9c3dbdxxi";
  };

  goDeps = ./deps.nix;

  buildInputs = [ makeWrapper ];

  preBuild = ''
    buildFlagsArray+=("-ldflags" "-X main.VERSION=v${version}")
  '';

  postInstall = ''
    wrapProgram $bin/bin/terragrunt \
      --set TERRAGRUNT_TFPATH ${terraform}/bin/terraform
  '';

  meta = with stdenv.lib; {
    description = "A thin wrapper for Terraform that supports locking for Terraform state and enforces best practices.";
    homepage = https://github.com/gruntwork-io/terragrunt/;
    license = licenses.mit;
  };

}
```

And auto-generated deps.nix of the working v0.19.19:

```
# file generated from Gopkg.lock using dep2nix (https://github.com/nixcloud/dep2nix)
[
  {
    goPackagePath  = "cloud.google.com/go";
    fetch = {
      type = "git";
      url = "https://code.googlesource.com/gocloud";
      rev =  "28a4bc8c44b3acbcc482cff0cdf7de29a4688b61";
      sha256 = "0j40msxm72m8gs87rpwkk19iagjj387r42xwxszmrna7il8g0sbl";
    };
  }
  {
    goPackagePath  = "github.com/agext/levenshtein";
    fetch = {
      type = "git";
      url = "https://github.com/agext/levenshtein";
      rev =  "0ded9c86537917af2ff89bc9c78de6bd58477894";
      sha256 = "19d7q69yhcg7gl81j038rkbjz8yjb4qwnsqrmxa4zvhgzlc7d130";
    };
  }
  {
    goPackagePath  = "github.com/apparentlymart/go-cidr";
    fetch = {
      type = "git";
      url = "https://github.com/apparentlymart/go-cidr";
      rev =  "b1115bf8e14a60131a196f908223e4506b0ddc35";
      sha256 = "0r938rb18c9cr2k417cwwd4pfq74aabpjp9pzvk4qkxc5279igl3";
    };
  }
  {
    goPackagePath  = "github.com/apparentlymart/go-textseg";
    fetch = {
      type = "git";
      url = "https://github.com/apparentlymart/go-textseg";
      rev =  "fb01f485ebef760e5ee06d55e1b07534dda2d295";
      sha256 = "0n9xcyj7p5y8mbqilk9zprfyqvgm2y9f1g440wqw9dnn3s4fi1k4";
    };
  }
  {
    goPackagePath  = "github.com/aws/aws-sdk-go";
    fetch = {
      type = "git";
      url = "https://github.com/aws/aws-sdk-go";
      rev =  "bdafd99f31a0103ec73bcabfc9498aef3252d515";
      sha256 = "09hcmk036vwd5cz01l0dsmjqwj628xcygwfr1d4hmprm3vdq78p4";
    };
  }
  {
    goPackagePath  = "github.com/bgentry/go-netrc";
    fetch = {
      type = "git";
      url = "https://github.com/bgentry/go-netrc";
      rev =  "9fd32a8b3d3d3f9d43c341bfe098430e07609480";
      sha256 = "0dn2h8avgavqdzdqnph8bkhj35bx0wssczry1zdczr22xv650g1l";
    };
  }
  {
    goPackagePath  = "github.com/davecgh/go-spew";
    fetch = {
      type = "git";
      url = "https://github.com/davecgh/go-spew";
      rev =  "8991bc29aa16c548c550c7ff78260e27b9ab7c73";
      sha256 = "0hka6hmyvp701adzag2g26cxdj47g21x6jz4sc6jjz1mn59d474y";
    };
  }
  {
    goPackagePath  = "github.com/go-errors/errors";
    fetch = {
      type = "git";
      url = "https://github.com/go-errors/errors";
      rev =  "a6af135bd4e28680facf08a3d206b454abc877a4";
      sha256 = "0rznpknk19rxkr7li6dqs52c26pjazp69lh493l4ny4sxn5922lp";
    };
  }
  {
    goPackagePath  = "github.com/golang/protobuf";
    fetch = {
      type = "git";
      url = "https://github.com/golang/protobuf";
      rev =  "b5d812f8a3706043e23a9cd5babf2e5423744d30";
      sha256 = "15am4s4646qy6iv0g3kkqq52rzykqjhm4bf08dk0fy2r58knpsyl";
    };
  }
  {
    goPackagePath  = "github.com/google/go-cmp";
    fetch = {
      type = "git";
      url = "https://github.com/google/go-cmp";
      rev =  "6f77996f0c42f7b84e5a2b252227263f93432e9b";
      sha256 = "1hyxx3434zshl2m9ja78gwlkg1rx9yl6diqa7dnjb31xz5x4gbjj";
    };
  }
  {
    goPackagePath  = "github.com/googleapis/gax-go";
    fetch = {
      type = "git";
      url = "https://github.com/googleapis/gax-go";
      rev =  "beaecbbdd8af86aa3acf14180d53828ce69400b2";
      sha256 = "1iwnm6ky1x53lgs44mw3hpdkjzrm5qd0kfs50m0qcq2ml5m1cwdm";
    };
  }
  {
    goPackagePath  = "github.com/gruntwork-io/terratest";
    fetch = {
      type = "git";
      url = "https://github.com/gruntwork-io/terratest";
      rev =  "a02960d4ef0711ae95ae2651271b4e073f88da4e";
      sha256 = "0mywsimj8if8j2jbp8sf4igl5lcdlj81hd3lif86fsmyrma090vw";
    };
  }
  {
    goPackagePath  = "github.com/hashicorp/errwrap";
    fetch = {
      type = "git";
      url = "https://github.com/hashicorp/errwrap";
      rev =  "8a6fb523712970c966eefc6b39ed2c5e74880354";
      sha256 = "0slfb6w3b61xz04r32bi0a1bygc82rjzhqkxj2si2074wynqnr1c";
    };
  }
  {
    goPackagePath  = "github.com/hashicorp/go-cleanhttp";
    fetch = {
      type = "git";
      url = "https://github.com/hashicorp/go-cleanhttp";
      rev =  "eda1e5db218aad1db63ca4642c8906b26bcf2744";
      sha256 = "07kx3fhryqmaw3czacmm11qwx63js2q8cfq967vphk7xg9q377kk";
    };
  }
  {
    goPackagePath  = "github.com/hashicorp/go-getter";
    fetch = {
      type = "git";
      url = "https://github.com/hashicorp/go-getter";
      rev =  "f9ec369200fd2163b8f452e5e45696d83ae3f4b6";
      sha256 = "1h69946nsmpp06iqg85whwvjrfqlk1gf9q7y01f0r3sf0cb28f30";
    };
  }
  {
    goPackagePath  = "github.com/hashicorp/go-multierror";
    fetch = {
      type = "git";
      url = "https://github.com/hashicorp/go-multierror";
      rev =  "886a7fbe3eb1c874d46f623bfa70af45f425b3d1";
      sha256 = "00nyn8llqzbfm8aflr9kwsvpzi4kv8v45c141v88xskxp5xf6z49";
    };
  }
  {
    goPackagePath  = "github.com/hashicorp/go-safetemp";
    fetch = {
      type = "git";
      url = "https://github.com/hashicorp/go-safetemp";
      rev =  "c9a55de4fe06c920a71964b53cfe3dd293a3c743";
      sha256 = "0gydks8bkq88adlzmv8qj3rvljx15j94c8lyrp88ji2jn6dvv643";
    };
  }
  {
    goPackagePath  = "github.com/hashicorp/go-uuid";
    fetch = {
      type = "git";
      url = "https://github.com/hashicorp/go-uuid";
      rev =  "4f571afc59f3043a65f8fe6bf46d887b10a01d43";
      sha256 = "0jvb88m0rq41bwgirsadgw7mnayl27av3gd2vqa3xvxp3fy0hp5k";
    };
  }
  {
    goPackagePath  = "github.com/hashicorp/go-version";
    fetch = {
      type = "git";
      url = "https://github.com/hashicorp/go-version";
      rev =  "ac23dc3fea5d1a983c43f6a0f6e2c13f0195d8bd";
      sha256 = "1bwi6y6111xq8ww8kjq0w1cmz15l1h9hb2id6596l8l0ag1vjj1z";
    };
  }
  {
    goPackagePath  = "github.com/hashicorp/golang-lru";
    fetch = {
      type = "git";
      url = "https://github.com/hashicorp/golang-lru";
      rev =  "7087cb70de9f7a8bc0a10c375cb0d2280a8edf9c";
      sha256 = "13f870cvk161bzjj6x41l45r5x9i1z9r2ymwmvm7768kg08zznpy";
    };
  }
  {
    goPackagePath  = "github.com/hashicorp/hcl2";
    fetch = {
      type = "git";
      url = "https://github.com/hashicorp/hcl2";
      rev =  "318e80eefe28c3aa01b434c61bcf4c83a0cc6b25";
      sha256 = "1wlm47qk84ggn6lanafirc49kaq998r1nw2xdcv4ghdxy2ijc0rj";
    };
  }
  {
    goPackagePath  = "github.com/hashicorp/terraform";
    fetch = {
      type = "git";
      url = "https://github.com/hashicorp/terraform";
      rev =  "a5fb573be1e8b5564f3fd879852a6681c55d6e8f";
      sha256 = "0azgxy31r9jdjj5x2n0sc1n1wjvq9q9zyrgl0rx631ppmjmsz31w";
    };
  }
  {
    goPackagePath  = "github.com/jmespath/go-jmespath";
    fetch = {
      type = "git";
      url = "https://github.com/jmespath/go-jmespath";
      rev =  "c2b33e84";
      sha256 = "1r6w7ydx8ydryxk3sfhzsk8m6f1nsik9jg3i1zhi69v4kfl4d5cz";
    };
  }
  {
    goPackagePath  = "github.com/mattn/go-zglob";
    fetch = {
      type = "git";
      url = "https://github.com/mattn/go-zglob";
      rev =  "2ea3427bfa539cca900ca2768d8663ecc8a708c1";
      sha256 = "1sncdyq5fbd42al4amyy91h7vlzm3wm6c9vl8za2pjgfgsd581fz";
    };
  }
  {
    goPackagePath  = "github.com/mitchellh/go-homedir";
    fetch = {
      type = "git";
      url = "https://github.com/mitchellh/go-homedir";
      rev =  "af06845cf3004701891bf4fdb884bfe4920b3727";
      sha256 = "0ydzkipf28hwj2bfxqmwlww47khyk6d152xax4bnyh60f4lq3nx1";
    };
  }
  {
    goPackagePath  = "github.com/mitchellh/go-testing-interface";
    fetch = {
      type = "git";
      url = "https://github.com/mitchellh/go-testing-interface";
      rev =  "6d0b8010fcc857872e42fc6c931227569016843c";
      sha256 = "1dl2js8di858bawg7dadlf1qjpkl2g3apziihjyf5imri3znyfpw";
    };
  }
  {
    goPackagePath  = "github.com/mitchellh/go-wordwrap";
    fetch = {
      type = "git";
      url = "https://github.com/mitchellh/go-wordwrap";
      rev =  "9e67c67572bc5dd02aef930e2b0ae3c02a4b5a5c";
      sha256 = "1jffbwcr3nnq6c12c5856bwzv2nxjzqk3jwgvxkwi1xhpd2by0bf";
    };
  }
  {
    goPackagePath  = "github.com/mitchellh/mapstructure";
    fetch = {
      type = "git";
      url = "https://github.com/mitchellh/mapstructure";
      rev =  "3536a929edddb9a5b34bd6861dc4a9647cb459fe";
      sha256 = "03bpv28jz9zhn4947saqwi328ydj7f6g6pf1m2d4m5zdh5jlfkrr";
    };
  }
  {
    goPackagePath  = "github.com/pmezard/go-difflib";
    fetch = {
      type = "git";
      url = "https://github.com/pmezard/go-difflib";
      rev =  "792786c7400a136282c1664665ae0a8db921c6c2";
      sha256 = "0c1cn55m4rypmscgf0rrb88pn58j3ysvc2d0432dp3c6fqg6cnzw";
    };
  }
  {
    goPackagePath  = "github.com/satori/go.uuid";
    fetch = {
      type = "git";
      url = "https://github.com/satori/go.uuid";
      rev =  "f58768cc1a7a7e77a3bd49e98cdd21419399b6a3";
      sha256 = "1j4s5pfg2ldm35y8ls8jah4dya2grfnx2drb4jcbjsyrp4cm5yfb";
    };
  }
  {
    goPackagePath  = "github.com/stretchr/testify";
    fetch = {
      type = "git";
      url = "https://github.com/stretchr/testify";
      rev =  "ffdc059bfe9ce6a4e144ba849dbedead332c6053";
      sha256 = "0wjchp2c8xbgcbbq32w3kvblk6q6yn533g78nxl6iskq6y95lxsy";
    };
  }
  {
    goPackagePath  = "github.com/ulikunitz/xz";
    fetch = {
      type = "git";
      url = "https://github.com/ulikunitz/xz";
      rev =  "6f934d456d51e742b4eeab20d925a827ef22320a";
      sha256 = "1qpk02c0nfgfyg110nmbaiy5x12fpn0pm8gy7h1s8pwns133n831";
    };
  }
  {
    goPackagePath  = "github.com/urfave/cli";
    fetch = {
      type = "git";
      url = "https://github.com/urfave/cli";
      rev =  "cfb38830724cc34fedffe9a2a29fb54fa9169cd1";
      sha256 = "0y6f4sbzkiiwrxbl15biivj8c7qwxnvm3zl2dd3mw4wzg4x10ygj";
    };
  }
  {
    goPackagePath  = "github.com/zclconf/go-cty";
    fetch = {
      type = "git";
      url = "https://github.com/zclconf/go-cty";
      rev =  "6fd39ad70c3a6bbdb1b4e47444e4cce72f901200";
      sha256 = "0mb0ws70jg93vlamzhdvyvyfq6x0s0ll5gf44yanb1dhlz6i1f90";
    };
  }
  {
    goPackagePath  = "github.com/zclconf/go-cty-yaml";
    fetch = {
      type = "git";
      url = "https://github.com/zclconf/go-cty-yaml";
      rev =  "fbabe99bb1c897a56ed70103a40aa94fc50a7104";
      sha256 = "0j0gfzzcvhvz94wq77hms1icbcw88mkf788a6v3xr3bj8xrc574h";
    };
  }
  {
    goPackagePath  = "go.opencensus.io";
    fetch = {
      type = "git";
      url = "https://github.com/census-instrumentation/opencensus-go";
      rev =  "9c377598961b706d1542bd2d84d538b5094d596e";
      sha256 = "05jr8gkr2w34i5wwki4zhl5ch0qrgi7cdgag5iy5gpxplhbrvbg9";
    };
  }
  {
    goPackagePath  = "golang.org/x/crypto";
    fetch = {
      type = "git";
      url = "https://go.googlesource.com/crypto";
      rev =  "5c40567a22f818bd14a1ea7245dad9f8ef0691aa";
      sha256 = "17g8fb9vy2sqq8vgz8jdvf6c6d2290gm2qs0i4yzsd86mgn4dlrg";
    };
  }
  {
    goPackagePath  = "golang.org/x/net";
    fetch = {
      type = "git";
      url = "https://go.googlesource.com/net";
      rev =  "461777fb6f67e8cb9d70cda16573678d085a74cf";
      sha256 = "0sc0llch05q6h7nqgayi3sgismsznpnlsz4gh89y4klpymdcpbh2";
    };
  }
  {
    goPackagePath  = "golang.org/x/oauth2";
    fetch = {
      type = "git";
      url = "https://go.googlesource.com/oauth2";
      rev =  "0f29369cfe4552d0e4bcddc57cc75f4d7e672a33";
      sha256 = "06jwpvx0x2gjn2y959drbcir5kd7vg87k0r1216abk6rrdzzrzi2";
    };
  }
  {
    goPackagePath  = "golang.org/x/sys";
    fetch = {
      type = "git";
      url = "https://go.googlesource.com/sys";
      rev =  "93c9922d18aeb82498a065f07aec7ad7fa60dfb7";
      sha256 = "0hv96nwbv0li3nrv43ldfzmf12yrrbji2cf8n44iibv8ps5kfssx";
    };
  }
  {
    goPackagePath  = "golang.org/x/text";
    fetch = {
      type = "git";
      url = "https://go.googlesource.com/text";
      rev =  "342b2e1fbaa52c93f31447ad2c6abc048c63e475";
      sha256 = "0flv9idw0jm5nm8lx25xqanbkqgfiym6619w575p7nrdh0riqwqh";
    };
  }
  {
    goPackagePath  = "google.golang.org/api";
    fetch = {
      type = "git";
      url = "https://code.googlesource.com/google-api-go-client";
      rev =  "890e5eb51fe205e56dc55eb68d63e82039730816";
      sha256 = "05r2wsjnmszsz4y59w8q6qknc7zq1mc56kya61i2133dqxyc55ai";
    };
  }
  {
    goPackagePath  = "google.golang.org/appengine";
    fetch = {
      type = "git";
      url = "https://github.com/golang/appengine";
      rev =  "b2f4a3cf3c67576a2ee09e1fe62656a5086ce880";
      sha256 = "0zxlvwzxwkwz4bs4h9zc9979dx76y4xf9ks4d22bclg47dv59yry";
    };
  }
  {
    goPackagePath  = "google.golang.org/genproto";
    fetch = {
      type = "git";
      url = "https://github.com/google/go-genproto";
      rev =  "eb0b1bdb6ae60fcfc41b8d907b50dfb346112301";
      sha256 = "0g00wfxd4z886bglyszcvfpgzak0476axqyfaqv3va62ndbqpk90";
    };
  }
  {
    goPackagePath  = "google.golang.org/grpc";
    fetch = {
      type = "git";
      url = "https://github.com/grpc/grpc-go";
      rev =  "501c41df7f472c740d0674ff27122f3f48c80ce7";
      sha256 = "0hla9rjvyi6wjak4cw39ic8jkdcd0lsymhrz9sa52bfybxsczf38";
    };
  }
]
```





***

**u-quark** commented *Aug 13, 2019*

Interestingly, I also tried to build with nix.

cc @forficate

Using your `default.nix`/`deps.nix` derivation I get a hash inconsistency:

```
unpacking source archive /build/v0.19.19.tar.gz
hash mismatch in fixed-output derivation '/nix/store/znwl35n5csk92482jdz7968wivdy0izj-source':
  wanted: sha256:0j7287g9lw06xvbxv9xi0g8zib0fbkihy67g7n1yygh9c3dbdxxi
  got:    sha256:0p99aaahkvvs31fx6i1vy9q997kfczh2kpsg7x16w2p5caivk8qb
cannot build derivation '/nix/store/52gj06k39y9q2zdyirqxh714dxjg9h1r-terragrunt-0.19.19.drv': 1 dependencies couldn't be built
error: build of '/nix/store/52gj06k39y9q2zdyirqxh714dxjg9h1r-terragrunt-0.19.19.drv' failed
```

After getting the correct hash I still get the same error as before.

@forficate What version of nixpkgs are you using? I am using:

```
https://github.com/NixOS/nixpkgs/archive/82d9988eb85f9f6d0de0da85b564d414d751d00c.tar.gz
```

from 2019-08-02.

---

It seems that the problem has to do with vendoring libraries in go. `dep` knows to fetch and pin `github.com/zclconf/go-cty` as a transitive dependency of the `terraform` package. Then when inspecting the go workspace (`GOPATH`) prepared by `dep` it seem like it has removed all the `vendor` directories from the packages. Even though `dep2nix` seems to refer to the correct packages from `Gopkg.lock` during building it seems that the `vendor` folders are not removed.

To make it work I added this to the `preBuild` hook, not sure if it is a proper solution:

```nix
  preBuild = ''
    buildFlagsArray+=("-ldflags" "-X main.VERSION=v${version}")

    find go/src -type d -name vendor -prune -exec rm -r '{}' ';'  # Remove vendor dirs
  '';
```

The rest of the derivation looks the same expect for the hash and the `deps.nix` is identical.

Relevant links:
https://golang.github.io/dep/docs/migrating.html#dealing-with-failures
https://gist.github.com/subfuzion/12342599e26f5094e4e2d08e9d4ad50d
https://blog.gopheracademy.com/advent-2015/vendor-folder/

***

